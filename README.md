# Домашнее задание к занятию 12.8 «Резервное копирование баз данных» - Евгений Шахов.
---
### Задание 1. Резервное копирование
##### Кейс
##### Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. Необходимо описать, какие варианты резервного копирования подходят в случаях:
##### 1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.
> Дифференциальный бэкап справится с этой задачей быстрей всех остальных методов.
##### 1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.
> Инкрементный бекап, он будет занимать минимум места относительно других типов резервного копирования
##### 1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.
###### Приведите ответ в свободной форме.
> Master-slave


---
### Задание 2. PostgreSQL
##### 2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).  
> Дамп
> ```
> pg_dump -Fc bd_name > dump.sql  
> ```
> Восстановление  
> ```
> pg_restore –d bd_name dump.sql  
> ```
##### 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?  
###### Приведите ответ в свободной форме.
> ###### Вариант 1. Запуск от пользователя root; одна база.  
> ``` #!/bin/sh  
> PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin  
> 
> PGPASSWORD=password
> export PGPASSWORD
> pathB=/backup
> dbUser=dbuser
> database=db
> 
> find $pathB \( -name "*-1[^5].*" -o -name "*-[023]?.*" \) -ctime +61 -delete
> pg_dump -U $dbUser $database | gzip > $pathB/pgsql_$(date "+%Y-%m-%d").sql.gz
> 
> unset PGPASSWORD 
> ```
> * где password — пароль для подключения к postgresql; /backup — каталог, в котором будут храниться резервные копии; dbuser — имя учетной записи для подключения к БУБД; pathB — путь до каталога, где будут храниться резервные копии.  
> * данный скрипт сначала удалит все резервные копии, старше 61 дня, но оставит от 15-о числа как длительный архив. После при помощи утилиты pg_dump будет выполнено подключение и резервирование базы db. Пароль экспортируется в системную переменную на момент выполнения задачи.  
> 
> Для запуска резервного копирования по расписанию, сохраняем скрипт в файл, например, /scripts/postgresql_dump.sh и создаем задание в планировщике:  
> ```
> crontab -e
> 
> 3 0 * * * /scripts/postgresql_dump.sh 
> ```
> * наш скрипт будет запускаться каждый день в 03:00.

> ###### Вариант 2. Запуск от пользователя postgres; все базы.
> ```
> #!/bin/bash
> PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
> 
> pathB=/backup/postgres
> 
> find $pathB \( -name "*-1[^5].*" -o -name "*-[023]?.*" \) -ctime +61 -delete
> 
> for dbname in `echo "SELECT datname FROM pg_database;" | psql | tail -n +3 | head -n -2 | egrep -v 'template0|template1|postgres'`; do
>   pg_dump $dbname | gzip > $pathB/$dbname-$(date "+%Y-%m-%d").sql.gz
> done;
> ```
> * где /backup — каталог, в котором будут храниться резервные копии; pathB — путь до каталога, где будут храниться резервные копии.
> * данный скрипт сначала удалит все резервные копии, старше 61 дня, но оставит от 15-о числа как длительный архив. После найдет все созданные в СУБД базы, кроме служебных и при помощи утилиты pg_dump будет выполнено резервирование каждой найденной базы. Пароль нам не нужен, так как по умолчанию, пользователь postgres имеет возможность подключаться к базе без пароля.
> 
> Необходимо убедиться, что у пользователя postgres будет разрешение на запись в каталог назначения, в нашем примере, /backup/postgres.
> 
> Зададим в качестве владельца файла, пользователя postgres:
> ```
> chown postgres:postgres /scripts/postgresql_dump.sh
> ```
> Для запуска резервного копирования по расписанию, сохраняем скрипт в файл, например, /scripts/postgresql_dump.sh и создаем задание в планировщике:
> ```
> crontab -e -u postgres
> ```
> * мы откроем на редактирование cron для пользователя postgres.
> ```
> 3 0 * * * /scripts/postgresql_dump.sh
> ```
> * наш скрипт будет запускаться каждый день в 03:00.


---
### Задание 3. MySQL
##### 3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
> полный бекап
> ```
> xtrabackup --backup --user=root --password='**' --target-dir=/root/backupdb/full  
> ```
> инкрементный бекап
> ```
> xtrabackup --backup --target-dir=/root/backupdb/inc1 --incremental-basedir=/root/backupdb/full
> ```
##### 3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?
###### Приведите ответ в свободной форме.


---
